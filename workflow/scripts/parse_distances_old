#!/usr/bin/env python3

import argparse
import pandas as pd
from loguru import logger


def load_data(file_path):
    """
    Load data from a file into a pandas DataFrame.
    """
    try:
        # Read entire file with all columns as strings
        df = pd.read_csv(file_path, sep="\t", dtype=str)
        logger.info("Data loaded successfully from {}", file_path)
        return df
    except Exception as e:
        logger.debug("No matches found. Returning empty df", e)
        return pd.DataFrame()
        # raise


def preprocess_data(df):
    """
    Preprocess the DataFrame: Convert 'Difference' to numeric and filter non-NaN rows.
    """
    if df.empty:
        return pd.DataFrame()
    logger.debug("Starting preprocessing of data")
    df["Difference"] = pd.to_numeric(df["Difference"], errors="coerce")
    filtered_df = df[df["Difference"].notna()].copy()
    logger.info("Preprocessed data, {} rows remaining after filtering",
                len(filtered_df))
    logger.debug("Filtered DataFrame head:\n{}", filtered_df.head())
    return filtered_df


def find_closest_differences(df):
    """
    Find the rows with 'Difference' closest to 0 for each GenomeID and GeneID pair.
    """
    if df.empty:
        return pd.DataFrame()
    logger.debug(
        "Finding closest differences for each GenomeID and GeneID pair")
    # Vectorized extraction of GenomeID from the 'Contig' column.
    df["GenomeID"] = df["Contig"].str.split(".").str[0]

    # Use a temporary column to compute the absolute difference.
    df["AbsDifference"] = df["Difference"].abs()
    # For each group, find the index of the row with the smallest absolute difference.
    idx = df.groupby(["GenomeID", "GeneID"])["AbsDifference"].idxmin()
    closest_diff_df = df.loc[idx].reset_index(drop=True)
    # Drop the temporary column.
    closest_diff_df.drop(columns="AbsDifference", inplace=True)

    logger.info(
        "Found closest differences, resulting DataFrame has {} rows",
        len(closest_diff_df),
    )
    logger.debug("Closest differences DataFrame head:\n{}",
                 closest_diff_df.head())

    return closest_diff_df


def save_to_file(df, output_file):
    """
    Save the DataFrame to a CSV file.
    """
    try:
        df.to_csv(output_file, index=False)
        logger.info("Data saved successfully to {}", output_file)
    except Exception as e:
        logger.error("Failed to save data: {}", e)
        raise


def main():
    """
    Main function to run the analysis.
    """
    parser = argparse.ArgumentParser(
        description="Analyze genomic data for closest differences.")
    parser.add_argument("file_path", help="Path to the genomic data file")
    parser.add_argument("output", help="Path to the output dataframe file")

    args = parser.parse_args()

    df = load_data(args.file_path)
    filtered_df = preprocess_data(df)
    closest_diff_df = find_closest_differences(filtered_df)
    logger.info("Found closest differences per genome/gene!")
    save_to_file(closest_diff_df, args.output)
    logger.success("File saved to {}", args.output)


if __name__ == "__main__":
    main()
