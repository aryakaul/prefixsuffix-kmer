#!/usr/bin/env python3

import argparse
import pandas as pd
import os
from loguru import logger

def load_and_preprocess_chunks(file_path):
    """
    Load and preprocess the file in chunks. Only keep rows with valid numeric 'Difference'.
    If the input file is completely empty, return an empty DataFrame.
    """
    # 1) fast-path for totally empty file on disk
    if os.path.getsize(file_path) == 0:
        logger.info("Input file '{}' is empty (0 bytes).", file_path)
        return pd.DataFrame()

    chunk_size = 50_000
    processed_chunks = []

    # 2) catch the case where pd.read_csv can't find a header at all
    try:
        reader = pd.read_csv(
            file_path,
            sep="\t",
            dtype=str,
            chunksize=chunk_size
        )
    except:
        logger.info("Input file '{}' has no data or header. Returning empty DataFrame.", file_path)
        return pd.DataFrame()

    for chunk in reader:
        # coerce Difference to numeric, drop non-numeric
        chunk["Difference"] = pd.to_numeric(chunk["Difference"], errors="coerce")
        filtered = chunk.loc[chunk["Difference"].notna()].copy()
        if filtered.empty:
            continue

        # extract GenomeID, compute absolute difference
        filtered["GenomeID"]    = filtered["Contig"].str.split(".").str[0]
        filtered["AbsDifference"] = filtered["Difference"].abs()
        processed_chunks.append(filtered)

    if not processed_chunks:
        logger.info("No matching rows found after preprocessing.")
        return pd.DataFrame()

    df = pd.concat(processed_chunks, ignore_index=True)
    logger.info("Loaded and preprocessed data with {} rows.", len(df))
    return df

def find_closest_differences(df):
    """
    For each GenomeID and GeneID pair, retain only the row with the smallest absolute difference.
    """
    if df.empty:
        return df

    idx = df.groupby(["GenomeID", "GeneID"])["AbsDifference"].idxmin()
    closest_df = df.loc[idx].copy()
    closest_df.drop(columns="AbsDifference", inplace=True)

    logger.info("Identified {} rows with closest differences.",
                len(closest_df))
    return closest_df


def save_to_file(df, output_file):
    """
    Save DataFrame to a CSV file.
    """
    try:
        df.to_csv(output_file, index=False)
        logger.info("Saved output to {}", output_file)
    except Exception as e:
        logger.error("Failed to save output: {}", e)
        raise


def main():
    parser = argparse.ArgumentParser(
        description="Find rows with closest differences.")
    parser.add_argument("file_path", help="Input TSV file path")
    parser.add_argument("output", help="Output CSV file path")
    args = parser.parse_args()
    os.makedirs(os.path.dirname(args.output), exist_ok=True)

    df = load_and_preprocess_chunks(args.file_path)
    closest_df = find_closest_differences(df)
    save_to_file(closest_df, args.output)
    logger.success("Done! Results written to {}", args.output)


if __name__ == "__main__":
    main()
